<!-- Archivo: B1_Registro.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>B-1 Registro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Puedes quitar esta CDN si no la necesitas; no es obligatoria -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.min.css">

  <style>
    :root{
      --brand:#27ae60;
      --brand-2:#2ecc71;
      --text:#333;
      --danger:#d32f2f;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      color: var(--text);
      background: url('https://www.panchovilla.cl/wp-content/uploads/2022/08/Ensalada-de-camaron-y-palta.jpg') no-repeat center center fixed;
      background-size: cover;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    .container {
      background-color: rgba(255,255,255,0.92);
      backdrop-filter: blur(2px);
      padding: 28px;
      border-radius: 12px;
      width: 100%;
      max-width: 420px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.25);
    }
    h3{margin-top:0; text-align:center; color:var(--brand)}
    .field{margin:10px 0 14px}
    label{display:block; font-weight:bold; margin-bottom:6px}
    input[type="text"], input[type="password"], input[type="email"]{
      width:100%; padding:11px 12px; border-radius:8px; border:1px solid #cfcfcf;
      font-size:15px; outline:none;
    }
    input:focus{border-color: var(--brand)}
    .input-row{position:relative}
    .toggle-pass{
      position:absolute; right:10px; top:50%; transform:translateY(-50%);
      background:none; border:none; cursor:pointer; font-size:12px; color:#555;
    }
    button{
      background-color: var(--brand);
      color:#fff; border:none; border-radius:8px; cursor:pointer;
      width:100%; padding:12px; font-size:16px; font-weight:bold;
    }
    button:hover{ background-color: var(--brand-2); }
    .error{
      color: var(--danger); font-size:0.95em; margin-top:8px; text-align:center; min-height:1.2em;
    }
    .links{
      text-align:center; margin-top:14px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;
    }
    .links a{
      color: var(--brand); text-decoration:none; font-weight:bold;
    }
    .links a:hover{text-decoration:underline}
    .hint{font-size:12px; color:#666; margin-top:-6px; margin-bottom:10px}
  </style>
</head>
<body>
  <main class="container" role="main" aria-labelledby="title">
    <h3 id="title">Registro</h3>

    <div class="field">
      <label for="email">Email</label>
      <input type="email" id="email" placeholder="usuario@correo.com" autocomplete="email" required>
      <div class="hint">Ejemplos de prueba: cliente1/2/3/4@example.com</div>
    </div>

    <div class="field input-row">
      <label for="pass">Contraseña</label>
      <input type="password" id="pass" placeholder="••••••••" autocomplete="new-password" required minlength="3">
      <button class="toggle-pass" id="togglePass" aria-label="Mostrar u ocultar contraseña" type="button">Mostrar</button>
    </div>

    <div class="field">
      <label for="nombre">Nombre (opcional)</label>
      <input type="text" id="nombre" placeholder="Tu nombre" autocomplete="name">
    </div>

    <button id="registrar">Registrar</button>
    <p id="mensaje" class="error" aria-live="polite"></p>

    <div class="links">
      <a href="index.html">Volver al inicio</a>
      <a href="B4_Inicio_Sesion.html">¿Ya tienes cuenta? Inicia sesión</a>
    </div>
  </main>

  <!-- Cargar API -->
  <script src="api.js"></script>
  
  <script>
    const emailInput = document.getElementById('email');
    const passInput = document.getElementById('pass');
    const nombreInput = document.getElementById('nombre');
    const registrarBtn = document.getElementById('registrar');
    const mensaje = document.getElementById('mensaje');
    const togglePass = document.getElementById('togglePass');

    // Helpers
    function isEmailValid(e){
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e);
    }
    
    function setMsg(text, isError = true){ 
      mensaje.textContent = text || ''; 
      mensaje.className = isError ? 'error' : 'success';
      mensaje.style.color = isError ? '#d32f2f' : '#2e7d32';
    }

    // Mostrar/ocultar contraseña
    togglePass.addEventListener('click', () => {
      const showing = passInput.type === 'text';
      passInput.type = showing ? 'password' : 'text';
      togglePass.textContent = showing ? 'Mostrar' : 'Ocultar';
      passInput.focus();
    });

    // Submit con Enter
    [emailInput, passInput, nombreInput].forEach(el => {
      if (el) {
        el.addEventListener('keypress', (e) => {
          if(e.key === 'Enter'){ e.preventDefault(); registrarBtn.click(); }
        });
      }
    });

    // Lógica de registro con API real
    registrarBtn.addEventListener('click', async () => {
      const email = emailInput.value.trim();
      const pass = passInput.value.trim();
      const nombre = nombreInput.value.trim() || 'Usuario';

      // Validaciones
      if (email === "" || pass === "") {
        return setMsg("Completa email y contraseña");
      }
      if (!isEmailValid(email)) {
        return setMsg("Formato de email inválido");
      }
      if (pass.length < 3) {
        return setMsg("La contraseña debe tener al menos 3 caracteres");
      }

      // Deshabilitar botón mientras procesa
      registrarBtn.disabled = true;
      registrarBtn.textContent = "Registrando...";
      setMsg("");

      try {
        // Llamar a la API
        const resultado = await API.registrarUsuario(nombre, email, pass);
        
        if (resultado && resultado._id) {
          // Registro exitoso
          setMsg("¡Registro exitoso! Redirigiendo...", false);
          
          // Guardar datos en localStorage
          localStorage.setItem('usuarioFB', JSON.stringify({
            id: resultado._id,
            nombre: resultado.nombre,
            email: resultado.email,
            telefono: resultado.telefono || ""
          }));
          
          // Redirigir al perfil
          setTimeout(() => {
            window.location.href = "B33_ver_perfil.html";
          }, 1000);
        } else {
          // Error del servidor
          setMsg("El email ya está registrado o hubo un error");
        }
      } catch (error) {
        setMsg("Error de conexión. Intenta de nuevo.");
        console.error("Error registro:", error);
      } finally {
        registrarBtn.disabled = false;
        registrarBtn.textContent = "Registrar";
      }
    });

    // Foco inicial
    window.addEventListener('load', () => emailInput.focus());
  </script>
</body>
</html>
