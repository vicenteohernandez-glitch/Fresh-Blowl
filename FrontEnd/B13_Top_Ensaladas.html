<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Top Ensaladas - Fresh Bowl</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family:'Poppins',sans-serif; background:#f9f9f9; margin:0; color:#333; }
  header { background:#fff; padding:10px 40px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 8px rgba(0,0,0,0.1); position:sticky; top:0; }
  .chart-container { width:90%; max-width:900px; margin:40px auto; background:white; padding:20px; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
  h2 { text-align:center; color:#388E3C; margin:8px 0 16px; }
  .toolbar { display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin-bottom:10px; }
  .btn { padding:8px 12px; border-radius:8px; border:none; background:#4CAF50; color:#fff; font-weight:700; cursor:pointer; }
  .btn:hover { background:#388E3C; }
  .muted { text-align:center; color:#666; font-size:.9em; margin-top:8px }
</style>
</head>
<body>

<header><div class="logo"><h1>Fresh Bowl</h1></div></header>

<section class="chart-container">
  <h2>ðŸ¥‡ Top Ensaladas - Unidades Vendidas ðŸ¥‡</h2>
  <div class="toolbar">
    <button class="btn" id="btnExport">Descargar PNG</button>
  </div>
  <canvas id="topEnsaladas"></canvas>
  <p class="muted" id="origen"></p>
</section>

<script>
/* ========== 1) Fuente de datos ==========
   Si hay localStorage.orders (array de {items:[{name, qty}]...}),
   calculamos dinÃ¡micamente el ranking. Si no hay, usamos tu dataset fijo.
*/
function getOrders(){
  try{
    const raw = localStorage.getItem('orders');
    if(!raw) return null;
    const arr = JSON.parse(raw);
    return Array.isArray(arr) ? arr : null;
  }catch{ return null; }
}

function computeFromOrders(orders){
  // Sumamos qty por nombre de producto
  const map = new Map();
  orders.forEach(o=>{
    (o.items||[]).forEach(it=>{
      const name = (it.name || it.id || 'Producto').toString();
      const qty  = Number(it.qty||0);
      map.set(name, (map.get(name)||0) + qty);
    });
  });
  // Orden descendente por unidades
  const pairs = Array.from(map.entries()).sort((a,b)=>b[1]-a[1]);
  return {
    labels: pairs.map(p=>p[0]),
    data:   pairs.map(p=>p[1]),
    source: 'Datos en vivo desde pedidos (localStorage.orders)'
  };
}

function getStaticDataset(){
  const labels = ['Caprese','Griega','NiÃ§oise','MediterrÃ¡nea','CÃ©sar','Tropical','Mimosa','Waldorf','Rusa'];
  const data   = [120, 135, 110, 95, 180, 75, 210, 190, 205];
  return { labels, data, source: 'Datos de ejemplo (estÃ¡ticos)' };
}

const orders = getOrders();
const dataset = orders && orders.length ? computeFromOrders(orders) : getStaticDataset();

/* ========== 2) Colores (destaca top-4) ========== */
function barColors(data){
  const sorted = [...data].sort((a,b)=>b-a);
  const top4 = new Set(sorted.slice(0,4)); // top 4 valores
  return data.map(v => top4.has(v) ? '#ffd700' : '#6497b1'); // dorado vs azul
}

/* ========== 3) Render Chart.js ========== */
const ctx = document.getElementById('topEnsaladas').getContext('2d');
let chart;
function renderChart(){
  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: dataset.labels,
      datasets: [{
        label: 'Unidades Vendidas',
        data: dataset.data,
        backgroundColor: barColors(dataset.data)
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (ctx) => ` ${ctx.raw.toLocaleString('es-CL')} unidades`
          }
        }
      },
      scales: {
        y: { beginAtZero: true, title: { display: true, text: 'Unidades' } },
        x: { title: { display: true, text: 'Ensaladas' } }
      }
    }
  });
  // Altura razonable segÃºn cantidad
  const rows = Math.ceil(dataset.labels.length / 8);
  document.getElementById('topEnsaladas').style.height = (300 + (rows-1)*120) + 'px';
  document.getElementById('origen').textContent = dataset.source;
}
renderChart();

/* ========== 4) Exportar PNG ========== */
document.getElementById('btnExport').addEventListener('click', ()=>{
  const url = chart.toBase64Image('image/png', 1.0);
  const a = document.createElement('a');
  a.href = url; a.download = 'top_ensaladas.png';
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
});

</script>
</body>
</html>
