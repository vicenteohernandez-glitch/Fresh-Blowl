<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Top Ensaladas - Fresh Bowl</title>
<link rel="stylesheet" href="estilos.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family:'Poppins',sans-serif; background:#f9f9f9; margin:0; color:#333; }
  header { background:#fff; padding:10px 40px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 8px rgba(0,0,0,0.1); position:sticky; top:0; }
  .chart-container { width:90%; max-width:900px; margin:40px auto; background:white; padding:20px; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
  h2 { text-align:center; color:#388E3C; margin:8px 0 16px; }
  .toolbar { display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin-bottom:10px; }
  .btn { padding:8px 12px; border-radius:8px; border:none; background:#4CAF50; color:#fff; font-weight:700; cursor:pointer; }
  .btn:hover { background:#388E3C; }
  .muted { text-align:center; color:#666; font-size:.9em; margin-top:8px }
  .back-link { display:inline-block; padding:10px 20px; color:#4CAF50; text-decoration:none; }
  .back-link:hover { text-decoration:underline; }
  .loading { text-align:center; padding:2rem; color:#666; }
</style>
</head>
<body>

<header>
  <div class="logo"><h1>Fresh Bowl</h1></div>
  <a href="index.html" class="back-link">‚Üê Volver</a>
</header>

<section class="chart-container">
  <h2>ü•á Top Ensaladas - Unidades Vendidas ü•á</h2>
  <div class="toolbar">
    <button class="btn" id="btnExport">Descargar PNG</button>
    <button class="btn" id="btnRefresh">üîÑ Actualizar</button>
  </div>
  <div id="chartWrapper">
    <p class="loading">Cargando datos...</p>
  </div>
  <p class="muted" id="origen"></p>
</section>

<script src="api.js"></script>
<script>
let chart = null;
let dataset = null;

async function cargarDatos() {
  const wrapper = document.getElementById('chartWrapper');
  wrapper.innerHTML = '<p class="loading">Cargando datos de pedidos...</p>';
  
  try {
    // Intentar obtener pedidos de la API
    const pedidos = await API.getPedidos();
    
    if (pedidos && pedidos.length > 0) {
      dataset = computeFromPedidos(pedidos);
    } else {
      // Si no hay pedidos, mostrar productos disponibles
      const productos = await API.getProductos();
      if (productos && productos.length > 0) {
        dataset = {
          labels: productos.slice(0, 10).map(p => p.nombre),
          data: productos.slice(0, 10).map(() => Math.floor(Math.random() * 100) + 20),
          source: 'Productos disponibles (sin pedidos a√∫n)'
        };
      } else {
        dataset = getStaticDataset();
      }
    }
    
    // Crear canvas
    wrapper.innerHTML = '<canvas id="topEnsaladas" style="min-height: 300px;"></canvas>';
    renderChart();
    
  } catch (err) {
    console.error('Error cargando datos:', err);
    dataset = getStaticDataset();
    wrapper.innerHTML = '<canvas id="topEnsaladas" style="min-height: 300px;"></canvas>';
    renderChart();
  }
}

function computeFromPedidos(pedidos) {
  // Sumar cantidad vendida por producto
  const map = new Map();
  
  pedidos.forEach(pedido => {
    const items = pedido.items || pedido.productos || [];
    items.forEach(item => {
      const nombre = item.nombre || item.name || item.producto_nombre || 'Producto';
      const cantidad = Number(item.cantidad || item.qty || 1);
      map.set(nombre, (map.get(nombre) || 0) + cantidad);
    });
  });
  
  // Ordenar por cantidad descendente
  const pairs = Array.from(map.entries()).sort((a, b) => b[1] - a[1]);
  
  return {
    labels: pairs.map(p => p[0]),
    data: pairs.map(p => p[1]),
    source: `Datos reales de ${pedidos.length} pedidos (API)`
  };
}

function getStaticDataset() {
  return {
    labels: ['Ensalada C√©sar', 'Bowl Mediterr√°neo', 'Ensalada Griega', 'Bowl Tropical', 'Ensalada Caprese'],
    data: [45, 38, 32, 28, 22],
    source: 'Datos de ejemplo (sin pedidos registrados)'
  };
}

function barColors(data) {
  const sorted = [...data].sort((a, b) => b - a);
  const top3 = new Set(sorted.slice(0, 3));
  return data.map(v => top3.has(v) ? '#ffd700' : '#6497b1');
}

function renderChart() {
  const canvas = document.getElementById('topEnsaladas');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  
  if (chart) chart.destroy();
  
  chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: dataset.labels,
      datasets: [{
        label: 'Unidades Vendidas',
        data: dataset.data,
        backgroundColor: barColors(dataset.data),
        borderRadius: 4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (ctx) => ` ${ctx.raw.toLocaleString('es-CL')} unidades`
          }
        }
      },
      scales: {
        y: { beginAtZero: true, title: { display: true, text: 'Unidades' } },
        x: { title: { display: true, text: 'Productos' } }
      }
    }
  });
  
  document.getElementById('origen').textContent = dataset.source;
}

// Exportar PNG
document.getElementById('btnExport').addEventListener('click', () => {
  if (!chart) return alert('No hay gr√°fico para exportar');
  const url = chart.toBase64Image('image/png', 1.0);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'top_ensaladas.png';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
});

// Refresh
document.getElementById('btnRefresh').addEventListener('click', cargarDatos);

// Inicializar
cargarDatos();
</script>
</body>
</html>
