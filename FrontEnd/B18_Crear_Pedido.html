<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mi Carrito - Fresh Bowl</title>
<style>
* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: 'Segoe UI', Arial, sans-serif;
  background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
  min-height: 100vh;
  padding: 20px;
}
.container {
  max-width: 900px;
  margin: 0 auto;
}
h2 { color: #2e7d32; margin-bottom: 20px; }

.cart-section {
  background: white;
  border-radius: 12px;
  padding: 25px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  margin-bottom: 20px;
}

.cart-item {
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 15px 0;
  border-bottom: 1px solid #eee;
}
.cart-item:last-child { border-bottom: none; }
.cart-item img {
  width: 80px;
  height: 80px;
  object-fit: cover;
  border-radius: 8px;
  background: #f5f5f5;
}
.cart-item .info { flex: 1; }
.cart-item .info h4 { margin: 0 0 5px 0; color: #333; }
.cart-item .info .price { color: #2e7d32; font-weight: bold; }
.cart-item .qty-control {
  display: flex;
  align-items: center;
  gap: 10px;
}
.cart-item .qty-control button {
  width: 32px;
  height: 32px;
  border: 1px solid #ddd;
  background: #f5f5f5;
  border-radius: 6px;
  cursor: pointer;
  font-size: 1.1em;
}
.cart-item .qty-control button:hover { background: #e8f5e9; }
.cart-item .qty-control span { font-weight: bold; min-width: 30px; text-align: center; }
.cart-item .subtotal {
  font-weight: bold;
  color: #333;
  min-width: 100px;
  text-align: right;
}
.cart-item .remove {
  background: #ffebee;
  color: #c62828;
  border: none;
  padding: 8px 12px;
  border-radius: 6px;
  cursor: pointer;
}
.cart-item .remove:hover { background: #ffcdd2; }

.cart-empty {
  text-align: center;
  padding: 40px;
  color: #666;
}
.cart-empty a {
  display: inline-block;
  margin-top: 15px;
  background: #27ae60;
  color: white;
  padding: 12px 25px;
  border-radius: 8px;
  text-decoration: none;
}

.summary {
  background: #f9f9f9;
  padding: 20px;
  border-radius: 8px;
  margin-top: 20px;
}
.summary .row {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
}
.summary .row.total {
  border-top: 2px solid #2e7d32;
  margin-top: 10px;
  padding-top: 15px;
  font-size: 1.2em;
  font-weight: bold;
  color: #2e7d32;
}

.checkout-section {
  background: white;
  border-radius: 12px;
  padding: 25px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}
.checkout-section h3 { color: #2e7d32; margin-bottom: 20px; }

.form-group {
  margin-bottom: 15px;
}
.form-group label {
  display: block;
  margin-bottom: 5px;
  font-weight: 500;
  color: #333;
}
.form-group input, .form-group select, .form-group textarea {
  width: 100%;
  padding: 12px;
  border: 1px solid #ddd;
  border-radius: 8px;
  font-size: 1em;
}
.form-group input:focus, .form-group select:focus {
  outline: none;
  border-color: #27ae60;
}

.btn {
  padding: 14px 30px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 1em;
  font-weight: bold;
  transition: all 0.3s;
}
.btn-primary {
  background: #27ae60;
  color: white;
  width: 100%;
}
.btn-primary:hover { background: #2ecc71; }
.btn-primary:disabled { background: #ccc; cursor: not-allowed; }
.btn-outline {
  background: transparent;
  border: 2px solid #27ae60;
  color: #27ae60;
}

.links {
  display: flex;
  gap: 15px;
  margin-top: 20px;
  justify-content: center;
}
.links a {
  color: #27ae60;
  text-decoration: none;
  font-weight: 500;
}
.links a:hover { text-decoration: underline; }

.message {
  padding: 15px;
  border-radius: 8px;
  margin-top: 15px;
  display: none;
}
.message.success { background: #e8f5e9; color: #2e7d32; display: block; }
.message.error { background: #ffebee; color: #c62828; display: block; }

.delivery-options {
  display: flex;
  gap: 15px;
  margin-bottom: 15px;
}
.delivery-option {
  flex: 1;
  padding: 15px;
  border: 2px solid #ddd;
  border-radius: 8px;
  cursor: pointer;
  text-align: center;
  transition: all 0.3s;
}
.delivery-option:hover { border-color: #27ae60; }
.delivery-option.selected {
  border-color: #27ae60;
  background: #e8f5e9;
}
.delivery-option .icon { font-size: 1.5em; margin-bottom: 5px; }
.delivery-option .price { color: #2e7d32; font-weight: bold; }
</style>
</head>
<body>

<div class="container">
  <h2>üõí Mi Carrito</h2>
  
  <div class="cart-section">
    <div id="cart-items">
      <!-- Items del carrito se cargan aqu√≠ -->
    </div>
    
    <div class="summary" id="cart-summary" style="display: none;">
      <div class="row">
        <span>Subtotal</span>
        <span id="subtotal">$0</span>
      </div>
      <div class="row">
        <span>Env√≠o</span>
        <span id="envio">$0</span>
      </div>
      <div class="row total">
        <span>Total</span>
        <span id="total">$0</span>
      </div>
    </div>
  </div>

  <div class="checkout-section" id="checkout-form" style="display: none;">
    <h3>üì¶ Datos de Entrega</h3>
    
    <div class="delivery-options">
      <div class="delivery-option selected" data-type="delivery" data-cost="2500">
        <div class="icon">üöö</div>
        <div>Delivery</div>
        <div class="price">$2.500</div>
      </div>
      <div class="delivery-option" data-type="pickup" data-cost="0">
        <div class="icon">üè™</div>
        <div>Retiro en tienda</div>
        <div class="price">Gratis</div>
      </div>
    </div>

    <div id="address-fields">
      <div class="form-group">
        <label>Direcci√≥n de entrega</label>
        <input type="text" id="direccion" placeholder="Ej: Av. Principal 123, Santiago">
      </div>
      <div class="form-group">
        <label>Referencia (opcional)</label>
        <input type="text" id="referencia" placeholder="Ej: Departamento 502, Torre A">
      </div>
    </div>

    <div class="form-group">
      <label>Tel√©fono de contacto</label>
      <input type="tel" id="telefono" placeholder="+56 9 1234 5678">
    </div>

    <div class="form-group">
      <label>Notas adicionales (opcional)</label>
      <textarea id="notas" rows="2" placeholder="Instrucciones especiales..."></textarea>
    </div>

    <button class="btn btn-primary" id="btn-pagar">
      Continuar al Pago
    </button>

    <div id="mensaje" class="message"></div>
  </div>

  <div class="links">
    <a href="B6_ListaProducto.html">‚Üê Seguir comprando</a>
    <a href="B11_Historial_Pedidos.html">Ver mis pedidos</a>
    <a href="index.html">Inicio</a>
  </div>
</div>

<script src="api.js"></script>
<script>
// Estado
let carrito = [];
let tipoEntrega = 'delivery';
let costoEnvio = 2500;

// Formatear precio
function fmtCLP(n) {
  return new Intl.NumberFormat('es-CL', {
    style: 'currency',
    currency: 'CLP',
    maximumFractionDigits: 0
  }).format(n);
}

// Cargar carrito desde localStorage
function cargarCarrito() {
  carrito = JSON.parse(localStorage.getItem('carritoFB') || '[]');
  renderCarrito();
}

// Guardar carrito
function guardarCarrito() {
  localStorage.setItem('carritoFB', JSON.stringify(carrito));
}

// Renderizar items del carrito
function renderCarrito() {
  const container = document.getElementById('cart-items');
  const summary = document.getElementById('cart-summary');
  const checkoutForm = document.getElementById('checkout-form');
  
  if (carrito.length === 0) {
    container.innerHTML = `
      <div class="cart-empty">
        <p>Tu carrito est√° vac√≠o</p>
        <a href="B6_ListaProducto.html">Ver productos</a>
      </div>
    `;
    summary.style.display = 'none';
    checkoutForm.style.display = 'none';
    return;
  }
  
  container.innerHTML = carrito.map((item, index) => `
    <div class="cart-item">
      <img src="${item.imagen || 'https://via.placeholder.com/80?text=ü•ó'}" 
           alt="${item.nombre}"
           onerror="this.src='https://via.placeholder.com/80?text=ü•ó'">
      <div class="info">
        <h4>${item.nombre}</h4>
        <div class="price">${fmtCLP(item.precio)} c/u</div>
      </div>
      <div class="qty-control">
        <button onclick="cambiarCantidad(${index}, -1)">‚àí</button>
        <span>${item.qty}</span>
        <button onclick="cambiarCantidad(${index}, 1)">+</button>
      </div>
      <div class="subtotal">${fmtCLP(item.precio * item.qty)}</div>
      <button class="remove" onclick="eliminarItem(${index})">‚úï</button>
    </div>
  `).join('');
  
  actualizarTotales();
  summary.style.display = 'block';
  checkoutForm.style.display = 'block';
}

// Cambiar cantidad
function cambiarCantidad(index, delta) {
  carrito[index].qty += delta;
  if (carrito[index].qty <= 0) {
    carrito.splice(index, 1);
  }
  guardarCarrito();
  renderCarrito();
}

// Eliminar item
function eliminarItem(index) {
  carrito.splice(index, 1);
  guardarCarrito();
  renderCarrito();
}

// Actualizar totales
function actualizarTotales() {
  const subtotal = carrito.reduce((sum, item) => sum + (item.precio * item.qty), 0);
  const total = subtotal + costoEnvio;
  
  document.getElementById('subtotal').textContent = fmtCLP(subtotal);
  document.getElementById('envio').textContent = costoEnvio > 0 ? fmtCLP(costoEnvio) : 'Gratis';
  document.getElementById('total').textContent = fmtCLP(total);
}

// Opciones de entrega
document.querySelectorAll('.delivery-option').forEach(opt => {
  opt.addEventListener('click', () => {
    document.querySelectorAll('.delivery-option').forEach(o => o.classList.remove('selected'));
    opt.classList.add('selected');
    
    tipoEntrega = opt.dataset.type;
    costoEnvio = parseInt(opt.dataset.cost);
    
    // Mostrar/ocultar campos de direcci√≥n
    document.getElementById('address-fields').style.display = 
      tipoEntrega === 'delivery' ? 'block' : 'none';
    
    actualizarTotales();
  });
});

// Crear pedido
document.getElementById('btn-pagar').addEventListener('click', async () => {
  const btn = document.getElementById('btn-pagar');
  const mensaje = document.getElementById('mensaje');
  
  // Validar usuario logueado
  const usuario = JSON.parse(localStorage.getItem('usuarioFB') || '{}');
  if (!usuario.id && !usuario.email) {
    mensaje.className = 'message error';
    mensaje.textContent = 'Debes iniciar sesi√≥n para continuar';
    setTimeout(() => {
      window.location.href = 'B4_Inicio_Sesion.html';
    }, 1500);
    return;
  }
  
  // Validar direcci√≥n si es delivery
  const direccion = document.getElementById('direccion').value.trim();
  if (tipoEntrega === 'delivery' && !direccion) {
    mensaje.className = 'message error';
    mensaje.textContent = 'Ingresa una direcci√≥n de entrega';
    return;
  }
  
  const telefono = document.getElementById('telefono').value.trim();
  if (!telefono) {
    mensaje.className = 'message error';
    mensaje.textContent = 'Ingresa un tel√©fono de contacto';
    return;
  }
  
  btn.disabled = true;
  btn.textContent = 'Procesando...';
  mensaje.className = 'message';
  mensaje.style.display = 'none';
  
  try {
    // Calcular total
    const subtotal = carrito.reduce((sum, item) => sum + (item.precio * item.qty), 0);
    const total = subtotal + costoEnvio;
    
    // Crear pedido
    const pedidoData = {
      usuario_id: usuario.id || null,
      items: carrito.map(item => ({
        producto_id: item.id,
        nombre: item.nombre,
        cantidad: item.qty,
        precio_unitario: item.precio,
        subtotal: item.precio * item.qty
      })),
      subtotal: subtotal,
      costo_envio: costoEnvio,
      total: total,
      tipo_entrega: tipoEntrega,
      direccion_entrega: tipoEntrega === 'delivery' ? {
        direccion: direccion,
        referencia: document.getElementById('referencia').value.trim(),
        telefono: telefono
      } : null,
      notas: document.getElementById('notas').value.trim(),
      estado: 'pendiente'
    };
    
    const pedido = await API.crearPedido(pedidoData);
    
    if (pedido && pedido._id) {
      // Guardar pedido para la p√°gina de pago
      localStorage.setItem('pedidoActual', JSON.stringify({
        id: pedido._id,
        total: total,
        items: carrito.length
      }));
      
      // Limpiar carrito
      localStorage.removeItem('carritoFB');
      
      mensaje.className = 'message success';
      mensaje.textContent = '¬°Pedido creado! Redirigiendo al pago...';
      
      setTimeout(() => {
        window.location.href = 'B21_pasarela_pago.html';
      }, 1500);
    } else {
      throw new Error('No se pudo crear el pedido');
    }
  } catch (error) {
    console.error('Error:', error);
    mensaje.className = 'message error';
    mensaje.textContent = 'Error al crear el pedido. Intenta de nuevo.';
    btn.disabled = false;
    btn.textContent = 'Continuar al Pago';
  }
});

// Iniciar
cargarCarrito();
</script>
</body>
</html>
