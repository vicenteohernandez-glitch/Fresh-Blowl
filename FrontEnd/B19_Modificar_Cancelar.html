<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Modificar/Cancelar Pedido - Fresh Bowl</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: 'Segoe UI', Arial, sans-serif;
  background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
  min-height: 100vh;
  padding: 20px;
}
header {
  background: white;
  padding: 15px 30px;
  border-radius: 12px;
  margin-bottom: 20px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
}
header h1 { color: #2e7d32; margin: 0; font-size: 1.4em; }
header a { color: #27ae60; text-decoration: none; font-weight: 500; }

.container { max-width: 600px; margin: 0 auto; }

.card {
  background: white;
  border-radius: 12px;
  padding: 25px;
  margin-bottom: 15px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.card h3 { margin-top: 0; color: #2e7d32; }

.pedido-item {
  border: 2px solid #e0e0e0;
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 12px;
  cursor: pointer;
  transition: all 0.3s;
}
.pedido-item:hover { border-color: #27ae60; }
.pedido-item.selected { border-color: #2e7d32; background: #e8f5e9; }

.pedido-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
}
.pedido-id { font-weight: bold; color: #2e7d32; }
.pedido-estado {
  padding: 4px 10px;
  border-radius: 15px;
  font-size: 0.85em;
  font-weight: 500;
}
.estado-pendiente { background: #fff3e0; color: #ef6c00; }
.estado-preparacion { background: #e3f2fd; color: #1976d2; }
.estado-listo { background: #e8f5e9; color: #2e7d32; }
.estado-enviado { background: #f3e5f5; color: #7b1fa2; }
.estado-entregado { background: #e0e0e0; color: #616161; }
.estado-cancelado { background: #ffebee; color: #c62828; }

.pedido-info { font-size: 0.9em; color: #666; }
.pedido-total { font-weight: bold; margin-top: 8px; }

.actions {
  display: flex;
  gap: 10px;
  margin-top: 20px;
}
.btn {
  flex: 1;
  padding: 14px;
  border: none;
  border-radius: 10px;
  font-size: 1em;
  font-weight: bold;
  cursor: pointer;
}
.btn-danger { background: #c62828; color: white; }
.btn-danger:hover { background: #b71c1c; }
.btn-danger:disabled { background: #ccc; cursor: not-allowed; }

.mensaje {
  text-align: center;
  padding: 12px;
  border-radius: 8px;
  margin-top: 15px;
  display: none;
}
.mensaje.error { display: block; background: #ffebee; color: #c62828; }
.mensaje.success { display: block; background: #e8f5e9; color: #2e7d32; }

.empty {
  text-align: center;
  padding: 40px;
  color: #999;
}
.empty .icon { font-size: 3em; margin-bottom: 10px; }

.nota {
  background: #fff3e0;
  padding: 12px;
  border-radius: 8px;
  font-size: 0.9em;
  color: #e65100;
  margin-top: 15px;
}
</style>
</head>
<body>
<header>
  <h1>ü•ó Fresh Bowl</h1>
  <a href="B11_Historial_Pedidos.html">‚Üê Historial</a>
</header>

<div class="container">
  <div class="card">
    <h3>üìù Modificar o Cancelar Pedido</h3>
    <p>Selecciona un pedido para cancelarlo. Solo puedes cancelar pedidos en estado <strong>Pendiente</strong> o <strong>Preparaci√≥n</strong>.</p>
    
    <div id="pedidos-list">
      <div class="empty">
        <div class="icon">üì¶</div>
        <p>Cargando pedidos...</p>
      </div>
    </div>
    
    <div class="actions">
      <button class="btn btn-danger" id="btn-cancelar" disabled>‚ùå Cancelar Pedido</button>
    </div>
    
    <div class="mensaje" id="mensaje"></div>
    
    <div class="nota">
      ‚ö†Ô∏è <strong>Nota:</strong> Los pedidos en estado "Enviado" o "Entregado" no pueden ser cancelados.
    </div>
  </div>
</div>

<script src="api.js"></script>
<script>
const usuario = JSON.parse(localStorage.getItem("usuarioFB") || "null");
let pedidoSeleccionado = null;

// Estados que permiten cancelaci√≥n
const CANCELABLES = ['pendiente', 'preparacion', 'preparaci√≥n'];

function getEstadoClass(estado) {
  const e = (estado || '').toLowerCase();
  if (e.includes('pendiente')) return 'estado-pendiente';
  if (e.includes('preparac')) return 'estado-preparacion';
  if (e.includes('listo')) return 'estado-listo';
  if (e.includes('enviado') || e.includes('camino')) return 'estado-enviado';
  if (e.includes('entregado')) return 'estado-entregado';
  if (e.includes('cancelado')) return 'estado-cancelado';
  return '';
}

function formatFecha(fecha) {
  return new Date(fecha).toLocaleDateString('es-CL', {
    day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit'
  });
}

function formatCLP(n) {
  return '$' + Number(n || 0).toLocaleString('es-CL');
}

async function cargarPedidos() {
  const container = document.getElementById('pedidos-list');
  
  if (!usuario || !usuario._id) {
    container.innerHTML = '<div class="empty"><div class="icon">üîí</div><p>Debes iniciar sesi√≥n</p><a href="B4_Inicio_Sesion.html">Iniciar sesi√≥n</a></div>';
    return;
  }
  
  try {
    const pedidos = await API.getHistorialPedidos(usuario._id);
    
    if (!pedidos || pedidos.length === 0) {
      container.innerHTML = '<div class="empty"><div class="icon">üì≠</div><p>No tienes pedidos</p></div>';
      return;
    }
    
    // Ordenar por fecha (m√°s recientes primero)
    pedidos.sort((a, b) => new Date(b.fecha_creacion || 0) - new Date(a.fecha_creacion || 0));
    
    container.innerHTML = pedidos.map(p => {
      const estado = p.estado || 'pendiente';
      const esCancelable = CANCELABLES.includes(estado.toLowerCase());
      
      return `
        <div class="pedido-item ${esCancelable ? '' : 'disabled'}" 
             data-id="${p._id}" 
             data-cancelable="${esCancelable}"
             onclick="seleccionarPedido(this)">
          <div class="pedido-header">
            <span class="pedido-id">#${(p._id || '').slice(-8).toUpperCase()}</span>
            <span class="pedido-estado ${getEstadoClass(estado)}">${estado}</span>
          </div>
          <div class="pedido-info">
            üìÖ ${formatFecha(p.fecha_creacion)}
          </div>
          <div class="pedido-total">
            Total: ${formatCLP(p.total)}
          </div>
        </div>
      `;
    }).join('');
    
  } catch (error) {
    console.error("Error:", error);
    container.innerHTML = '<div class="empty"><div class="icon">‚ö†Ô∏è</div><p>Error al cargar pedidos</p></div>';
  }
}

function seleccionarPedido(el) {
  const cancelable = el.dataset.cancelable === 'true';
  
  // Quitar selecci√≥n anterior
  document.querySelectorAll('.pedido-item').forEach(p => p.classList.remove('selected'));
  
  if (cancelable) {
    el.classList.add('selected');
    pedidoSeleccionado = el.dataset.id;
    document.getElementById('btn-cancelar').disabled = false;
  } else {
    pedidoSeleccionado = null;
    document.getElementById('btn-cancelar').disabled = true;
    mostrarMensaje('Este pedido no puede ser cancelado', 'error');
  }
}

function mostrarMensaje(texto, tipo) {
  const msg = document.getElementById('mensaje');
  msg.textContent = texto;
  msg.className = 'mensaje ' + tipo;
  setTimeout(() => msg.className = 'mensaje', 3000);
}

document.getElementById('btn-cancelar').addEventListener('click', async () => {
  if (!pedidoSeleccionado) return;
  
  if (!confirm('¬øEst√°s seguro de cancelar este pedido?')) return;
  
  try {
    await API.actualizarPedido(pedidoSeleccionado, { estado: 'cancelado' });
    mostrarMensaje('‚úÖ Pedido cancelado correctamente', 'success');
    
    // Recargar lista
    setTimeout(() => cargarPedidos(), 1000);
    pedidoSeleccionado = null;
    document.getElementById('btn-cancelar').disabled = true;
    
  } catch (error) {
    console.error("Error:", error);
    mostrarMensaje('Error al cancelar el pedido', 'error');
  }
});

// Iniciar
cargarPedidos();
</script>
</body>
</html>
