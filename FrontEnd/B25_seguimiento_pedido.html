<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Seguimiento de Pedido - Fresh Bowl</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
* { box-sizing: border-box; }
body {
  margin: 0;
  font-family: 'Segoe UI', Arial, sans-serif;
  background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
  min-height: 100vh;
  padding: 20px;
}
.container { max-width: 600px; margin: 0 auto; }
.card {
  background: white;
  border-radius: 12px;
  padding: 30px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  margin-bottom: 20px;
}
h2 { color: #2e7d32; text-align: center; margin-bottom: 25px; }

.order-info {
  display: flex;
  justify-content: space-between;
  padding: 15px;
  background: #f9f9f9;
  border-radius: 8px;
  margin-bottom: 30px;
}
.order-info .item { text-align: center; }
.order-info .label { font-size: 0.8em; color: #666; }
.order-info .value { font-weight: bold; color: #333; }

.timeline {
  position: relative;
  padding-left: 30px;
}
.timeline::before {
  content: '';
  position: absolute;
  left: 10px;
  top: 0;
  bottom: 0;
  width: 3px;
  background: #e0e0e0;
}
.timeline-item {
  position: relative;
  padding-bottom: 30px;
}
.timeline-item:last-child { padding-bottom: 0; }
.timeline-item .dot {
  position: absolute;
  left: -26px;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: #e0e0e0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.7em;
  color: white;
}
.timeline-item.completed .dot { background: #27ae60; }
.timeline-item.current .dot {
  background: #27ae60;
  box-shadow: 0 0 0 4px rgba(39, 174, 96, 0.3);
  animation: pulse 2s infinite;
}
@keyframes pulse {
  0%, 100% { box-shadow: 0 0 0 4px rgba(39, 174, 96, 0.3); }
  50% { box-shadow: 0 0 0 8px rgba(39, 174, 96, 0.1); }
}
.timeline-item .content { padding-left: 15px; }
.timeline-item .title { font-weight: bold; color: #333; margin-bottom: 5px; }
.timeline-item .desc { font-size: 0.9em; color: #666; }
.timeline-item .time { font-size: 0.8em; color: #999; margin-top: 5px; }
.timeline-item.pending .title { color: #999; }

.delivery-info {
  background: #e3f2fd;
  padding: 20px;
  border-radius: 8px;
  margin-top: 25px;
}
.delivery-info h4 { margin: 0 0 15px 0; color: #1565c0; }
.delivery-row {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
}
.delivery-row .label { color: #666; }
.delivery-row .value { font-weight: bold; }

.map-placeholder {
  background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
  height: 200px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
  margin-top: 20px;
}
.map-placeholder .icon { font-size: 3em; margin-bottom: 10px; }
.map-placeholder .text { color: #666; }

.btn {
  display: block;
  width: 100%;
  padding: 14px;
  border: none;
  border-radius: 8px;
  font-size: 1em;
  font-weight: bold;
  cursor: pointer;
  text-align: center;
  text-decoration: none;
  margin-top: 15px;
}
.btn-primary { background: #27ae60; color: white; }
.btn-primary:hover { background: #2ecc71; }
.btn-outline { background: transparent; border: 2px solid #27ae60; color: #27ae60; }

.links { text-align: center; margin-top: 20px; }
.links a { color: #27ae60; text-decoration: none; margin: 0 15px; }

.no-order {
  text-align: center;
  padding: 40px;
}
.no-order a {
  display: inline-block;
  margin-top: 15px;
  background: #27ae60;
  color: white;
  padding: 12px 25px;
  border-radius: 8px;
  text-decoration: none;
}
</style>
</head>
<body>
<div class="container">
  <div class="card" id="content">
    <!-- Contenido cargado din√°micamente -->
  </div>
  <div class="links">
    <a href="B11_Historial_Pedidos.html">Ver todos mis pedidos</a>
    <a href="index.html">Inicio</a>
  </div>
</div>
<script src="api.js"></script>
<script>
// Estados del pedido con tiempos simulados
const estadosPedido = [
  { id: 'confirmado', titulo: 'Pedido Confirmado', desc: 'Tu pedido ha sido recibido', icon: '‚úì' },
  { id: 'preparando', titulo: 'En Preparaci√≥n', desc: 'Estamos preparando tu ensalada fresca', icon: 'üë®‚Äçüç≥' },
  { id: 'listo', titulo: 'Listo para Env√≠o', desc: 'Tu pedido est√° empacado y listo', icon: 'üì¶' },
  { id: 'enviado', titulo: 'En Camino', desc: 'El repartidor va en camino a tu direcci√≥n', icon: 'üöö' },
  { id: 'entregado', titulo: 'Entregado', desc: '¬°Disfruta tu Fresh Bowl!', icon: 'üéâ' }
];

let estadoActual = 0;
let intervaloSimulacion = null;

function fmtHora(offset = 0) {
  const d = new Date(Date.now() - offset * 60000);
  return d.toLocaleTimeString('es-CL', { hour: '2-digit', minute: '2-digit' });
}

function cargarSeguimiento() {
  const content = document.getElementById('content');
  const pago = JSON.parse(localStorage.getItem('pagoCompletado') || 'null');
  
  if (!pago) {
    content.innerHTML = '<div class="no-order"><p>No hay un pedido activo para seguir</p><a href="B6_ListaProducto.html">Ver productos</a></div>';
    return;
  }
  
  renderSeguimiento(pago);
  iniciarSimulacion();
}

function renderSeguimiento(pago) {
  const content = document.getElementById('content');
  const idCorto = pago.pedido_id ? pago.pedido_id.slice(-8).toUpperCase() : 'DEMO';
  
  let timelineHTML = estadosPedido.map((estado, idx) => {
    let clase = '';
    let tiempo = '';
    
    if (idx < estadoActual) {
      clase = 'completed';
      tiempo = fmtHora((estadoActual - idx) * 5);
    } else if (idx === estadoActual) {
      clase = 'current';
      tiempo = 'Ahora';
    } else {
      clase = 'pending';
      tiempo = 'Pendiente';
    }
    
    return `
      <div class="timeline-item ${clase}">
        <div class="dot">${estado.icon}</div>
        <div class="content">
          <div class="title">${estado.titulo}</div>
          <div class="desc">${estado.desc}</div>
          <div class="time">${tiempo}</div>
        </div>
      </div>
    `;
  }).join('');
  
  const tiempoEstimado = Math.max(0, (4 - estadoActual) * 8);
  
  content.innerHTML = `
    <h2>üìç Seguimiento de Pedido</h2>
    
    <div class="order-info">
      <div class="item">
        <div class="label">N¬∫ Pedido</div>
        <div class="value">#${idCorto}</div>
      </div>
      <div class="item">
        <div class="label">Estado</div>
        <div class="value" style="color: #27ae60">${estadosPedido[estadoActual].titulo}</div>
      </div>
      <div class="item">
        <div class="label">Tiempo Est.</div>
        <div class="value">${tiempoEstimado > 0 ? tiempoEstimado + ' min' : '¬°Lleg√≥!'}</div>
      </div>
    </div>
    
    <div class="timeline">
      ${timelineHTML}
    </div>
    
    ${estadoActual >= 3 ? `
      <div class="map-placeholder">
        <div class="icon">üó∫Ô∏è</div>
        <div class="text">Mapa de seguimiento en tiempo real</div>
      </div>
    ` : ''}
    
    <div class="delivery-info">
      <h4>üì¶ Informaci√≥n de Entrega</h4>
      <div class="delivery-row">
        <span class="label">Tipo</span>
        <span class="value">Delivery</span>
      </div>
      <div class="delivery-row">
        <span class="label">Repartidor</span>
        <span class="value">${estadoActual >= 3 ? 'Carlos M. ‚≠ê 4.8' : 'Por asignar'}</span>
      </div>
    </div>
    
    <button class="btn btn-primary" onclick="actualizarEstado()">
      üîÑ Simular Avance
    </button>
    <a href="B22_boleta_digital.html" class="btn btn-outline">
      üìÑ Ver Boleta
    </a>
  `;
}

function actualizarEstado() {
  const pago = JSON.parse(localStorage.getItem('pagoCompletado') || '{}');
  if (estadoActual < estadosPedido.length - 1) {
    estadoActual++;
    renderSeguimiento(pago);
    
    if (estadoActual === estadosPedido.length - 1) {
      clearInterval(intervaloSimulacion);
    }
  }
}

function iniciarSimulacion() {
  // Auto-avanzar cada 10 segundos (demo)
  intervaloSimulacion = setInterval(() => {
    if (estadoActual < estadosPedido.length - 1) {
      actualizarEstado();
    } else {
      clearInterval(intervaloSimulacion);
    }
  }, 10000);
}

cargarSeguimiento();
</script>
</body>
</html>
