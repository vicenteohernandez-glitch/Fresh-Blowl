<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Detalle Producto - Fresh Bowl</title>
<style>
  body { 
    margin: 0; 
    font-family: 'Segoe UI', Arial, sans-serif; 
    background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
    min-height: 100vh;
    color: #333;
  }
  
  header { 
    background-color: #fff; 
    display: flex; 
    align-items: center; 
    justify-content: space-between; 
    padding: 10px 40px; 
    box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
    position: sticky; 
    top: 0; 
    z-index: 100; 
  }
  .logo { display: flex; align-items: center; gap: 10px; }
  .logo img { height: 50px; border-radius: 50%; }
  .logo h1 { font-size: 1.4em; color: #4CAF50; margin: 0; }
  
  nav ul { list-style: none; display: flex; gap: 25px; margin: 0; padding: 0; }
  nav a { text-decoration: none; color: #333; font-weight: 600; transition: color 0.3s; }
  nav a:hover { color: #4CAF50; }
  
  .nav-buttons { display: flex; align-items: center; gap: 15px; }
  .nav-buttons a { 
    background-color: #4CAF50; 
    color: white; 
    padding: 8px 14px; 
    border-radius: 8px; 
    text-decoration: none; 
    font-weight: bold; 
    transition: background-color 0.3s; 
  }
  .nav-buttons a:hover { background-color: #388E3C; }
  .nav-buttons a.outline { 
    background: transparent; 
    border: 2px solid #4CAF50; 
    color: #4CAF50; 
  }
  .nav-buttons a.outline:hover { background: #e8f5e9; }

  .container { 
    max-width: 1000px; 
    margin: 40px auto; 
    padding: 0 20px; 
  }
  
  .producto-detalle { 
    display: flex; 
    flex-wrap: wrap; 
    gap: 30px; 
    background: white; 
    padding: 30px; 
    border-radius: 15px; 
    box-shadow: 0 4px 20px rgba(0,0,0,0.1); 
  }
  .producto-detalle .img-container {
    flex: 1;
    min-width: 300px;
    max-width: 450px;
  }
  .producto-detalle img { 
    width: 100%; 
    border-radius: 15px; 
    object-fit: cover;
    background: #f5f5f5;
  }
  .detalle-info { 
    flex: 1; 
    min-width: 280px;
  }
  .detalle-info h2 { 
    color: #4CAF50; 
    font-size: 2em; 
    margin: 0 0 10px 0; 
  }
  .detalle-info .precio { 
    font-size: 1.8em; 
    color: #2e7d32; 
    font-weight: bold; 
    margin: 10px 0 15px 0;
  }
  .detalle-info .descripcion { 
    font-size: 1.1em; 
    color: #555;
    line-height: 1.6;
    margin-bottom: 20px; 
  }
  .detalle-info .categoria { 
    display: inline-block;
    background: #e8f5e9; 
    color: #2e7d32; 
    padding: 5px 12px; 
    border-radius: 20px; 
    font-size: 0.9em;
    margin-bottom: 20px;
  }
  .detalle-info .stock {
    font-size: 0.95em;
    margin-bottom: 15px;
  }
  .stock.disponible { color: #2e7d32; }
  .stock.agotado { color: #d32f2f; }
  
  .btn { 
    border: none; 
    padding: 14px 28px; 
    border-radius: 8px; 
    cursor: pointer; 
    font-weight: bold; 
    font-size: 1em;
    transition: all 0.3s; 
    margin-right: 10px;
    margin-top: 10px;
  }
  .btn-primary { background: #4CAF50; color: white; }
  .btn-primary:hover { background: #388E3C; transform: translateY(-2px); }
  .btn-primary:disabled { background: #ccc; cursor: not-allowed; transform: none; }
  .btn-outline { background: transparent; border: 2px solid #4CAF50; color: #4CAF50; }
  .btn-outline:hover { background: #e8f5e9; }
  
  .cantidad-control {
    display: flex;
    align-items: center;
    gap: 15px;
    margin: 20px 0;
  }
  .cantidad-control button {
    width: 40px;
    height: 40px;
    border: 2px solid #4CAF50;
    background: white;
    color: #4CAF50;
    font-size: 1.4em;
    border-radius: 8px;
    cursor: pointer;
  }
  .cantidad-control button:hover { background: #e8f5e9; }
  .cantidad-control span {
    font-size: 1.3em;
    font-weight: bold;
    min-width: 40px;
    text-align: center;
  }

  .ingredientes { 
    margin-top: 25px; 
    padding-top: 20px; 
    border-top: 1px solid #eee;
  }
  .ingredientes h4 { color: #4CAF50; margin-bottom: 10px; }
  .ingredientes-list { 
    display: flex; 
    flex-wrap: wrap; 
    gap: 8px; 
  }
  .ingrediente-tag {
    background: #f5f5f5;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.9em;
  }

  .loading { 
    text-align: center; 
    padding: 60px; 
    background: white;
    border-radius: 15px;
  }
  .loading .spinner {
    width: 50px;
    height: 50px;
    border: 4px solid #e8f5e9;
    border-top-color: #4CAF50;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  
  .error-msg {
    text-align: center;
    padding: 40px;
    background: #ffebee;
    border-radius: 15px;
    color: #c62828;
  }

  .feedback {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #4CAF50;
    color: white;
    padding: 15px 25px;
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    transform: translateY(100px);
    opacity: 0;
    transition: all 0.3s;
  }
  .feedback.show {
    transform: translateY(0);
    opacity: 1;
  }
</style>
</head>
<body>

<header>
  <div class="logo">
    <img src="https://i.pinimg.com/originals/9f/65/3f/9f653f870d7eda5e3d7068f9ef45fccc.jpg" alt="Fresh Bowl Logo">
    <h1>Fresh Bowl</h1>
  </div>
  <nav>
    <ul>
      <li><a href="index.html">Inicio</a></li>
      <li><a href="B6_ListaProducto.html">Productos</a></li>
      <li><a href="B13_Top_Ensaladas.html">Top Ensaladas</a></li>
    </ul>
  </nav>
  <div class="nav-buttons">
    <a href="B6_ListaProducto.html" class="outline">üõí Carrito</a>
    <a href="B4_Inicio_Sesion.html">Iniciar Sesi√≥n</a>
  </div>
</header>

<div class="container">
  <div id="producto-container">
    <div class="loading">
      <div class="spinner"></div>
      <p>Cargando producto...</p>
    </div>
  </div>
</div>

<div class="feedback" id="feedback"></div>

<script src="api.js"></script>

<script>
const container = document.getElementById('producto-container');
const feedback = document.getElementById('feedback');
let cantidad = 1;
let productoActual = null;

function fmtCLP(n) {
  return new Intl.NumberFormat('es-CL', {
    style: 'currency',
    currency: 'CLP',
    maximumFractionDigits: 0
  }).format(n);
}

function showFeedback(msg) {
  feedback.textContent = msg;
  feedback.classList.add('show');
  setTimeout(() => feedback.classList.remove('show'), 2000);
}

function getProductoId() {
  const params = new URLSearchParams(window.location.search);
  return params.get('id');
}

function renderProducto(p, categoria) {
  productoActual = p;
  const disponible = p.disponible !== false && (p.stock === undefined || p.stock > 0);
  
  container.innerHTML = `
    <div class="producto-detalle">
      <div class="img-container">
        <img src="${p.imagen_url || 'https://via.placeholder.com/450x350?text=Ensalada'}" 
             alt="${p.nombre}"
             onerror="this.src='https://via.placeholder.com/450x350?text=Ensalada'">
      </div>
      <div class="detalle-info">
        <h2>${p.nombre}</h2>
        ${categoria ? `<span class="categoria">${categoria}</span>` : ''}
        <div class="precio">${fmtCLP(p.precio)}</div>
        <p class="descripcion">${p.descripcion || 'Deliciosa ensalada fresca preparada con los mejores ingredientes.'}</p>
        
        <div class="stock ${disponible ? 'disponible' : 'agotado'}">
          ${disponible ? '‚úì Disponible' : '‚úó Agotado'}
          ${p.stock !== undefined ? ` (${p.stock} unidades)` : ''}
        </div>
        
        ${disponible ? `
          <div class="cantidad-control">
            <button id="btn-menos">‚àí</button>
            <span id="cantidad">1</span>
            <button id="btn-mas">+</button>
          </div>
          <button class="btn btn-primary" id="btn-agregar">üõí Agregar al carrito</button>
        ` : `
          <button class="btn btn-primary" disabled>Producto agotado</button>
        `}
        <a href="B6_ListaProducto.html" class="btn btn-outline">‚Üê Volver al cat√°logo</a>
        
        ${p.ingredientes && p.ingredientes.length ? `
          <div class="ingredientes">
            <h4>Ingredientes</h4>
            <div class="ingredientes-list">
              ${p.ingredientes.map(i => `<span class="ingrediente-tag">${i}</span>`).join('')}
            </div>
          </div>
        ` : ''}
      </div>
    </div>
  `;
  
  if (disponible) {
    document.getElementById('btn-menos').addEventListener('click', () => {
      if (cantidad > 1) {
        cantidad--;
        document.getElementById('cantidad').textContent = cantidad;
      }
    });
    
    document.getElementById('btn-mas').addEventListener('click', () => {
      const maxStock = p.stock || 99;
      if (cantidad < maxStock) {
        cantidad++;
        document.getElementById('cantidad').textContent = cantidad;
      }
    });
    
    document.getElementById('btn-agregar').addEventListener('click', () => {
      agregarAlCarrito(p, cantidad);
    });
  }
}

function agregarAlCarrito(p, qty) {
  let carrito = JSON.parse(localStorage.getItem('carritoFB') || '[]');
  
  const idx = carrito.findIndex(x => x.id === p._id);
  if (idx >= 0) {
    carrito[idx].qty += qty;
  } else {
    carrito.push({
      id: p._id,
      nombre: p.nombre,
      precio: p.precio,
      imagen: p.imagen_url || '',
      qty: qty
    });
  }
  
  localStorage.setItem('carritoFB', JSON.stringify(carrito));
  showFeedback(`‚úì ${qty} x ${p.nombre} agregado al carrito`);
  
  cantidad = 1;
  document.getElementById('cantidad').textContent = '1';
}

function showError(msg) {
  container.innerHTML = `
    <div class="error-msg">
      <h3>üòï ${msg}</h3>
      <p>El producto que buscas no existe o no est√° disponible.</p>
      <a href="B6_ListaProducto.html" class="btn btn-primary" style="margin-top: 15px; display: inline-block; text-decoration: none;">Ver todos los productos</a>
    </div>
  `;
}

async function cargarProducto() {
  const id = getProductoId();
  
  if (!id) {
    showError('No se especific√≥ un producto');
    return;
  }
  
  try {
    const producto = await API.getProducto(id);
    
    if (!producto) {
      showError('Producto no encontrado');
      return;
    }
    
    let categoriaNombre = null;
    if (producto.categoria_id) {
      try {
        const cat = await API.getCategoria(producto.categoria_id);
        if (cat) categoriaNombre = cat.nombre;
      } catch (e) {
        console.warn('No se pudo cargar categor√≠a');
      }
    }
    
    document.title = `${producto.nombre} - Fresh Bowl`;
    renderProducto(producto, categoriaNombre);
    
  } catch (error) {
    console.error('Error cargando producto:', error);
    showError('Error al cargar el producto');
  }
}

cargarProducto();
</script>
</body>
</html>
